<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login ‚Äì The Profits Circle (Debug)</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .error-message { color: var(--red); font-size: 0.85rem; margin-top: 0.5rem; text-align: center; }
    .debug-panel { 
      background: var(--black4); 
      border: 1px solid var(--border); 
      border-radius: 5px; 
      padding: 1rem; 
      margin-top: 1.5rem; 
      font-size: 0.8rem; 
      color: var(--white2); 
      max-height: 400px; 
      overflow: auto; 
    }
    .debug-header { 
      color: var(--gold); 
      font-weight: bold; 
      margin-bottom: 0.5rem; 
      cursor: pointer;
      user-select: none;
    }
    .debug-content { 
      display: none;
      font-family: monospace;
      white-space: pre-wrap;
      background: var(--black3);
      padding: 0.5rem;
      border-radius: 3px;
    }
    .debug-content.show { display: block; }
    .success { color: var(--green); }
    .error { color: var(--red); }
    .warning { color: var(--gold); }
    .test-btn {
      background: var(--gold-dim);
      color: var(--gold2);
      border: 1px solid var(--gold-border);
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      margin: 0.25rem;
      font-size: 0.8rem;
    }
    .test-btn:hover {
      background: var(--gold);
      color: var(--black);
    }
  </style>
</head>
<body style="background:radial-gradient(ellipse 70% 50% at 50% 0%, rgba(212,168,67,.07), transparent), var(--black); min-height: 100vh; display: flex; align-items: center; justify-content: center;">

<div class="login-container" style="width: 100%; max-width: 500px; padding: 1rem;">
  <div class="login-box" style="background: var(--black2); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 2rem;">
    <div class="login-logo" style="text-align: center; margin-bottom: 1.5rem;">
      <h1 style="font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 2px; margin: 0;">THE <span style="color: var(--gold);">PROFITS</span> CIRCLE</h1>
      <p style="color: var(--white3); font-size: 0.85rem; margin-top: 0.5rem;">Debug Login Mode</p>
    </div>

    <!-- LOGIN FORM -->
    <div style="margin-bottom: 1.5rem;">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="loginEmail" value="admin@theprofitscircle.co.uk" placeholder="Email" />
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="text" class="form-input" id="loginPassword" value="admin123" placeholder="Password" />
        <small style="color: var(--white3);">Password field is visible for debugging</small>
      </div>
      <button class="btn btn-gold btn-full" id="loginBtn" onclick="debugLogin()" style="margin-top: 1rem;">Test Login</button>
    </div>

    <!-- STATUS -->
    <div id="loginStatus" class="error-message" style="min-height: 30px;"></div>

    <!-- DEBUG PANEL -->
    <div class="debug-panel">
      <div class="debug-header" onclick="this.nextElementSibling.classList.toggle('show')">
        üîß Debug Information ‚ñº
      </div>
      <div class="debug-content show" id="debugContent">
        <div id="debugStatus">Loading debug info...</div>
      </div>
    </div>

    <!-- TEST BUTTONS -->
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
      <button class="test-btn" onclick="testHash()">Test Hash Function</button>
      <button class="test-btn" onclick="testDirectLogin()">Test Direct Login</button>
      <button class="test-btn" onclick="resetAndReload()">Reset & Reload</button>
      <button class="test-btn" onclick="createTestUser()">Create Test User</button>
    </div>

    <div style="text-align: center; margin-top: 1.5rem;">
      <a href="/" style="color: var(--white3); font-size: 0.8rem;">‚Üê Back to Home</a>
    </div>
  </div>
</div>

<div class="toast" id="siteToast"><span id="siteToastMsg"></span></div>

<script>
// ============================================
// COMPLETE PC OBJECT WITH DEBUGGING
// ============================================

window.PC = {};

// Storage
PC.storage = { users: [] };

// Toast
PC.toast = function(message, type = 'info') {
  const toast = document.getElementById('siteToast');
  const msgEl = document.getElementById('siteToastMsg');
  if (toast && msgEl) {
    msgEl.textContent = message;
    toast.className = 'toast show ' + type;
    setTimeout(() => toast.className = 'toast', 3000);
  } else {
    alert(message);
  }
};

// Hash function with multiple methods for debugging
PC.hashPassword = async function(password, method = 'sha256') {
  console.log(`Hashing password: "${password}" using ${method}`);
  
  if (method === 'sha256') {
    const msgBuffer = new TextEncoder().encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }
  
  return password; // fallback
};

// Simple hash for testing (not secure, just for debugging)
PC.simpleHash = function(password) {
  let hash = 0;
  for (let i = 0; i < password.length; i++) {
    const char = password.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  return Math.abs(hash).toString(16);
};

// Fetch users
PC.fetchUsers = async function() {
  try {
    const response = await fetch('users.json?' + Date.now());
    const data = await response.json();
    
    if (Array.isArray(data)) {
      PC.storage.users = data;
    } else if (data && Array.isArray(data.users)) {
      PC.storage.users = data.users;
    } else {
      PC.storage.users = [];
    }
    
    localStorage.setItem('pc_users', JSON.stringify(PC.storage.users));
    updateDebugInfo();
    return PC.storage.users;
  } catch (error) {
    console.error('Fetch error:', error);
    const cached = localStorage.getItem('pc_users');
    if (cached) {
      try {
        PC.storage.users = JSON.parse(cached);
      } catch (e) {
        PC.storage.users = [];
      }
    }
    updateDebugInfo();
    return PC.storage.users;
  }
};

// Find user
PC.findUser = function(email) {
  return PC.storage.users.find(u => u.email && u.email.toLowerCase() === email.toLowerCase());
};

// Verify password with debugging
PC.verifyPassword = async function(password, storedHash, debug = true) {
  console.log('=== Password Verification Debug ===');
  console.log('Input password:', password);
  console.log('Stored hash:', storedHash);
  
  // Try SHA-256
  const sha256Hash = await PC.hashPassword(password, 'sha256');
  console.log('SHA-256 of input:', sha256Hash);
  
  const sha256Match = sha256Hash === storedHash;
  console.log('SHA-256 match:', sha256Match);
  
  if (debug) {
    document.getElementById('debugStatus').innerHTML += `
      <br><span class="warning">üîç Password Check:</span><br>
      ‚Ä¢ Input: "${password}"<br>
      ‚Ä¢ Stored Hash: ${storedHash}<br>
      ‚Ä¢ SHA-256 Hash: ${sha256Hash}<br>
      ‚Ä¢ Match: ${sha256Match ? '‚úÖ' : '‚ùå'}<br>
    `;
  }
  
  return sha256Match;
};

// Login function with debugging
PC.login = async function(email, password) {
  const status = document.getElementById('loginStatus');
  status.innerHTML = 'Attempting login...';
  
  try {
    const users = PC.storage.users;
    status.innerHTML += `<br>Users loaded: ${users.length}`;
    
    const user = PC.findUser(email);
    if (!user) {
      status.innerHTML += `<br><span class="error">‚ùå Email not found: ${email}</span>`;
      return { ok: false, msg: 'Email not found' };
    }
    
    status.innerHTML += `<br>‚úÖ Found user: ${user.name} (${user.role})`;
    status.innerHTML += `<br>Stored hash: ${user.passwordHash.substring(0, 10)}...`;
    
    const isValid = await PC.verifyPassword(password, user.passwordHash);
    
    if (!isValid) {
      status.innerHTML += `<br><span class="error">‚ùå Password invalid</span>`;
      return { ok: false, msg: 'Invalid password' };
    }
    
    status.innerHTML += `<br><span class="success">‚úÖ Password valid!</span>`;
    
    const sessionUser = { ...user };
    delete sessionUser.passwordHash;
    localStorage.setItem('pc_user', JSON.stringify(sessionUser));
    
    return { ok: true, msg: 'Login successful', user: sessionUser };
    
  } catch (error) {
    status.innerHTML += `<br><span class="error">‚ùå Error: ${error.message}</span>`;
    return { ok: false, msg: error.message };
  }
};

// ========== DEBUG FUNCTIONS ==========
async function updateDebugInfo() {
  const debug = document.getElementById('debugContent');
  if (!debug) return;
  
  let html = '<span class="success">‚úÖ Debug Info Updated</span><br><br>';
  
  // Users loaded
  html += `<span class="warning">üìä Users in system: ${PC.storage.users.length}</span><br>`;
  
  // List all users
  PC.storage.users.forEach((u, i) => {
    html += `<br><span class="warning">User ${i+1}:</span><br>`;
    html += `‚Ä¢ Email: ${u.email}<br>`;
    html += `‚Ä¢ Name: ${u.name}<br>`;
    html += `‚Ä¢ Role: ${u.role}<br>`;
    html += `‚Ä¢ Hash: ${u.passwordHash ? u.passwordHash.substring(0, 20) + '...' : 'MISSING'}<br>`;
    html += `‚Ä¢ Hash length: ${u.passwordHash ? u.passwordHash.length : 0}<br>`;
  });
  
  // Test hash for admin123
  const testHash = await PC.hashPassword('admin123');
  html += `<br><span class="warning">üîë Test Data:</span><br>`;
  html += `‚Ä¢ Hash of "admin123": ${testHash}<br>`;
  html += `‚Ä¢ Should match: 240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9<br>`;
  html += `‚Ä¢ Match: ${testHash === '240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9' ? '‚úÖ' : '‚ùå'}<br>`;
  
  debug.innerHTML = html;
}

async function debugLogin() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const btn = document.getElementById('loginBtn');
  const status = document.getElementById('loginStatus');
  
  btn.disabled = true;
  btn.textContent = 'Testing...';
  status.innerHTML = '';
  
  const result = await PC.login(email, password);
  
  btn.disabled = false;
  btn.textContent = 'Test Login';
  
  if (result.ok) {
    status.innerHTML = `<span class="success">‚úÖ SUCCESS! Redirecting to admin...</span>`;
    setTimeout(() => window.location.href = '/admin', 1500);
  } else {
    status.innerHTML = `<span class="error">‚ùå ${result.msg}</span>`;
  }
}

async function testHash() {
  const password = document.getElementById('loginPassword').value;
  const hash = await PC.hashPassword(password);
  const status = document.getElementById('loginStatus');
  
  status.innerHTML = `
    <span class="warning">üîë Hash Test:</span><br>
    Password: "${password}"<br>
    SHA-256: ${hash}<br>
    Length: ${hash.length} characters
  `;
}

async function testDirectLogin() {
  const email = 'admin@theprofitscircle.co.uk';
  const password = 'admin123';
  
  const status = document.getElementById('loginStatus');
  status.innerHTML = 'Testing direct login...<br>';
  
  const hash = await PC.hashPassword(password);
  status.innerHTML += `Hash of "${password}": ${hash}<br>`;
  
  const user = PC.findUser(email);
  if (user) {
    status.innerHTML += `Found user with hash: ${user.passwordHash}<br>`;
    status.innerHTML += `Hashes match: ${hash === user.passwordHash ? '‚úÖ' : '‚ùå'}<br>`;
    
    if (hash !== user.passwordHash) {
      status.innerHTML += `<br><span class="error">‚ùå Hash mismatch! The stored hash doesn't match "admin123"</span>`;
      status.innerHTML += `<br>Update users.json with this hash: <strong>${hash}</strong>`;
    }
  } else {
    status.innerHTML += `<span class="error">‚ùå User not found!</span>`;
  }
}

function resetAndReload() {
  localStorage.removeItem('pc_users');
  localStorage.removeItem('pc_user');
  sessionStorage.removeItem('pc_user');
  location.reload();
}

async function createTestUser() {
  const hash = await PC.hashPassword('admin123');
  
  PC.storage.users = [{
    id: 1,
    name: "Admin",
    email: "admin@theprofitscircle.co.uk",
    passwordHash: hash,
    role: "admin",
    plan: "vip",
    vip: true,
    status: "active",
    joined: "2024-01-01",
    affiliate: true,
    referralCode: "ADMIN",
    referredBy: "",
    earnings: 0
  }];
  
  localStorage.setItem('pc_users', JSON.stringify(PC.storage.users));
  await updateDebugInfo();
  
  const status = document.getElementById('loginStatus');
  status.innerHTML = `<span class="success">‚úÖ Test user created with hash: ${hash}</span>`;
}

// Initialize
PC.fetchUsers().then(() => {
  updateDebugInfo();
  console.log('Users loaded:', PC.storage.users);
});

// Auto-run test on load
setTimeout(testDirectLogin, 500);
</script>
</body>
</html>
