<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login ‚Äì The Profits Circle</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body style="background:radial-gradient(ellipse 70% 50% at 50% 0%, rgba(212,168,67,.07), transparent), var(--black);">

<div class="login-container">
  <div class="login-box">
    <div class="login-logo">
      <a href="/" style="text-decoration:none;display:flex;flex-direction:column;align-items:center;gap:.5rem;">
        <img src="logo.png" alt="The Profits Circle" style="height:80px;width:auto;" onerror="this.style.display='none';this.nextElementSibling.style.display='block';" />
        <h1 style="display:none;">THE <span>PROFITS</span> CIRCLE</h1>
      </a>
      <p class="text-muted" style="font-size:.85rem;margin-top:.35rem;">Access your journal, calendar &amp; academy</p>
    </div>

    <div class="login-tabs">
      <div class="login-tab active" id="ltab-login" onclick="switchTab('login')">Log In</div>
      <div class="login-tab" id="ltab-signup" onclick="switchTab('signup')">Sign Up</div>
    </div>

    <!-- LOGIN FORM -->
    <div id="loginForm">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="loginEmail" placeholder="you@email.com" autocomplete="email" />
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()" />
      </div>
      <button class="btn btn-gold btn-full mt-2" id="loginBtn" onclick="doLogin()" style="min-height:50px;font-size:1rem;font-weight:700;">Log In ‚Üí</button>
    </div>

    <!-- SIGNUP FORM -->
    <div id="signupForm" style="display:none;">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input type="text" class="form-input" id="signupName" placeholder="Your name" autocomplete="name" />
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="signupEmail" placeholder="you@email.com" autocomplete="email" />
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="signupPassword" placeholder="Min. 8 characters" autocomplete="new-password" />
      </div>
      <div class="form-group">
        <label class="form-label">Referral Code <span style="color:var(--white3);font-weight:400;">(optional)</span></label>
        <input type="text" class="form-input" id="signupReferral" placeholder="e.g. JAMES22" style="text-transform:uppercase;" id="signupReferral" />
        <div id="referralStatus" style="font-size:.78rem;margin-top:.35rem;min-height:1.1rem;"></div>
      </div>
      <button class="btn btn-gold btn-full mt-1" id="signupBtn" onclick="doSignup()" style="min-height:50px;font-size:1rem;font-weight:700;">Create Account ‚Üí</button>
      <div style="display:flex;align-items:center;gap:.75rem;margin:1.25rem 0;">
        <div style="flex:1;height:1px;background:var(--border);"></div>
        <span style="font-size:.75rem;color:var(--white3);">or get instant VIP</span>
        <div style="flex:1;height:1px;background:var(--border);"></div>
      </div>
      <a href="/vip" class="btn btn-outline btn-full">Sign Up With Broker ‚Äî VIP Free</a>
    </div>

    <p class="text-center mt-3" style="font-size:.78rem;color:var(--white3);">
      By continuing you agree to our <a href="#" class="text-gold2">Terms</a> and <a href="#" class="text-gold2">Privacy Policy</a>
    </p>
    <div class="text-center mt-2">
      <a href="/" style="font-size:.82rem;color:var(--white3);">‚Üê Back to Home</a>
    </div>
  </div>
</div>

<div class="toast" id="siteToast"><span id="siteToastMsg"></span></div>

<script src="assets/app.js"></script>
<script>
// Redirect if already logged in
if (PC.isLoggedIn()) {
  const r = sessionStorage.getItem('pc_redirect') || './';
  sessionStorage.removeItem('pc_redirect');
  window.location.href = r;
}

// Pre-load users for referral validation
PC.fetchUsers().catch(()=>{});

// Pre-fill referral code from URL ?ref=CODE
const urlParams = new URLSearchParams(window.location.search);
const refCode = urlParams.get('ref');
if (refCode) {
  switchTab('signup');
  document.getElementById('signupReferral').value = refCode.toUpperCase();
  validateReferral(refCode);
}

function switchTab(tab) {
  document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('signupForm').style.display = tab === 'signup' ? 'block' : 'none';
  document.getElementById('ltab-login').className = 'login-tab' + (tab==='login'?' active':'');
  document.getElementById('ltab-signup').className = 'login-tab' + (tab==='signup'?' active':'');
}

function validateReferral(code) {
  const el = document.getElementById('referralStatus');
  if (!code) { el.textContent = ''; return; }
  const u = PC.findUserByReferral(code.toUpperCase());
  if (u) {
    el.innerHTML = `<span style="color:var(--green);">‚úì Valid referral code from ${u.name}</span>`;
  } else {
    el.innerHTML = `<span style="color:var(--red);">‚úó Invalid referral code</span>`;
  }
}

document.getElementById('signupReferral').addEventListener('input', function() {
  this.value = this.value.toUpperCase();
  validateReferral(this.value);
});

async function doLogin() {
  const btn = document.getElementById('loginBtn');
  const email = document.getElementById('loginEmail').value.trim();
  const pw = document.getElementById('loginPassword').value;
  if (!email || !pw) { PC.toast('Please fill in all fields', 'error'); return; }
  btn.disabled = true; btn.textContent = 'Signing in‚Ä¶';
  const res = await PC.login(email, pw);
  btn.disabled = false; btn.textContent = 'Log In ‚Üí';
  if (!res.ok) { PC.toast(res.msg, 'error'); return; }
  const user = PC.getUser();
  PC.toast('Welcome back, ' + user.name.split(' ')[0] + '! üëã', 'success');
  setTimeout(() => {
    const redirect = sessionStorage.getItem('pc_redirect') || (user.role === 'admin' ? '/admin' : './');
    sessionStorage.removeItem('pc_redirect');
    window.location.href = redirect;
  }, 700);
}

async function doSignup() {
  const btn = document.getElementById('signupBtn');
  const name = document.getElementById('signupName').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const pw = document.getElementById('signupPassword').value;
  const ref = document.getElementById('signupReferral').value.trim();
  if (!name || !email || !pw) { PC.toast('Please fill in all fields', 'error'); return; }
  if (pw.length < 8) { PC.toast('Password must be at least 8 characters', 'error'); return; }
  if (ref && !PC.findUserByReferral(ref)) { PC.toast('Invalid referral code', 'error'); return; }
  btn.disabled = true; btn.textContent = 'Creating account‚Ä¶';
  const res = await PC.signup(name, email, pw, ref);
  btn.disabled = false; btn.textContent = 'Create Account ‚Üí';
  if (!res.ok) { PC.toast(res.msg, 'error'); return; }
  if (res.needsSync) { PC.toast('Account created! Download users.json from Admin to sync across devices. üéâ', 'success'); }
  else { PC.toast('Account created! Welcome, ' + name.split(' ')[0] + '! üéâ', 'success'); }
  setTimeout(() => {
    const redirect = sessionStorage.getItem('pc_redirect') || './';
    sessionStorage.removeItem('pc_redirect');
    window.location.href = redirect;
  }, 900);
}
</script>
</body>
</html>
