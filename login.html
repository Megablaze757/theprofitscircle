<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login ‚Äì The Profits Circle</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .error-message { 
      color: var(--red); 
      font-size: 0.85rem; 
      margin-top: 0.5rem; 
      text-align: center;
      min-height: 30px;
      padding: 0.5rem;
      background: var(--black3);
      border-radius: 5px;
    }
    .success-message {
      color: var(--green);
    }
    .debug-panel { 
      background: var(--black4); 
      border: 1px solid var(--border); 
      border-radius: 5px; 
      padding: 1rem; 
      margin-top: 1.5rem; 
      font-size: 0.8rem; 
      color: var(--white2); 
      max-height: 400px; 
      overflow: auto; 
    }
    .debug-header { 
      color: var(--gold); 
      font-weight: bold; 
      margin-bottom: 0.5rem; 
      cursor: pointer;
      user-select: none;
      padding: 0.5rem;
      background: var(--black3);
      border-radius: 3px;
    }
    .debug-content { 
      display: block;
      font-family: monospace;
      white-space: pre-wrap;
      background: var(--black3);
      padding: 1rem;
      border-radius: 3px;
      margin-top: 0.5rem;
      line-height: 1.6;
    }
    .success { color: var(--green); font-weight: bold; }
    .error { color: var(--red); font-weight: bold; }
    .warning { color: var(--gold); font-weight: bold; }
    .test-btn {
      background: var(--gold-dim);
      color: var(--gold2);
      border: 1px solid var(--gold-border);
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      margin: 0.25rem;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    .test-btn:hover {
      background: var(--gold);
      color: var(--black);
    }
    .login-box {
      max-width: 500px;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--black2);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
    }
    .login-logo {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .login-logo h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      letter-spacing: 2px;
      margin: 0;
    }
    .login-logo h1 span {
      color: var(--gold);
    }
    .form-input {
      width: 100%;
      padding: 0.75rem;
      background: var(--black3);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--white);
      font-size: 1rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--white2);
      font-size: 0.9rem;
    }
    .btn-full {
      width: 100%;
    }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
  </style>
</head>
<body style="background:radial-gradient(ellipse 70% 50% at 50% 0%, rgba(212,168,67,.07), transparent), var(--black); min-height: 100vh; display: flex; align-items: center; justify-content: center;">

<div class="login-container" style="width: 100%; max-width: 500px; padding: 1rem;">
  <div class="login-box">
    <div class="login-logo">
      <h1>THE <span>PROFITS</span> CIRCLE</h1>
      <p style="color: var(--white3); font-size: 0.85rem; margin-top: 0.5rem;">Member Login</p>
    </div>

    <!-- LOGIN FORM -->
    <div style="margin-bottom: 1.5rem;">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="loginEmail" value="admin@theprofitscircle.co.uk" placeholder="Email" />
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="loginPassword" value="admin123" placeholder="Password" />
      </div>
      <button class="btn btn-gold btn-full mt-2" id="loginBtn" onclick="doLogin()" style="min-height:50px; font-size:1rem;">Log In</button>
    </div>

    <!-- STATUS MESSAGE -->
    <div id="loginStatus" class="error-message"></div>

    <!-- DEBUG PANEL (collapsible) -->
    <div class="debug-panel">
      <div class="debug-header" onclick="toggleDebug()">
        üîß System Status (click to expand/collapse)
      </div>
      <div id="debugContent" class="debug-content"></div>
    </div>

    <!-- QUICK ACTIONS -->
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; justify-content: center;">
      <button class="test-btn" onclick="testLogin()">Quick Test Login</button>
      <button class="test-btn" onclick="location.reload()">Reload Page</button>
    </div>

    <div style="text-align: center; margin-top: 1.5rem;">
      <a href="/" style="color: var(--white3); font-size: 0.8rem;">‚Üê Back to Home</a>
    </div>
  </div>
</div>

<div class="toast" id="siteToast"><span id="siteToastMsg"></span></div>

<script>
// ============================================
// SIMPLE WORKING LOGIN
// ============================================

// Simple toast function
function showToast(message, type = 'info') {
  const toast = document.getElementById('siteToast');
  const msgEl = document.getElementById('siteToastMsg');
  if (toast && msgEl) {
    msgEl.textContent = message;
    toast.className = 'toast show ' + type;
    setTimeout(() => toast.className = 'toast', 3000);
  } else {
    alert(message);
  }
}

// Password hashing function
async function hashPassword(password) {
  const msgBuffer = new TextEncoder().encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// Toggle debug panel
function toggleDebug() {
  const debug = document.getElementById('debugContent');
  if (debug.style.display === 'none') {
    debug.style.display = 'block';
  } else {
    debug.style.display = 'none';
  }
}

// Update debug info
async function updateDebugInfo() {
  const debugEl = document.getElementById('debugContent');
  if (!debugEl) return;
  
  try {
    // Get users from localStorage or fetch
    let users = [];
    const stored = localStorage.getItem('pc_users');
    if (stored) {
      users = JSON.parse(stored);
    }
    
    const testHash = await hashPassword('admin123');
    
    let html = '';
    html += '<span class="success">‚úÖ SYSTEM STATUS</span><br><br>';
    html += `<span class="warning">üìä Users loaded:</span> ${users.length}<br><br>`;
    
    users.forEach((user, index) => {
      html += `<span class="warning">üë§ User ${index + 1}:</span><br>`;
      html += `  ‚Ä¢ Email: ${user.email}<br>`;
      html += `  ‚Ä¢ Name: ${user.name}<br>`;
      html += `  ‚Ä¢ Role: ${user.role}<br>`;
      html += `  ‚Ä¢ Hash: ${user.passwordHash ? user.passwordHash.substring(0, 20) + '...' : 'MISSING'}<br>`;
    });
    
    html += `<br><span class="warning">üîë Password Test:</span><br>`;
    html += `  ‚Ä¢ Password "admin123" hash: ${testHash}<br>`;
    html += `  ‚Ä¢ Matches stored: ${testHash === '240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9' ? '‚úÖ YES' : '‚ùå NO'}<br>`;
    
    debugEl.innerHTML = html;
  } catch (e) {
    debugEl.innerHTML = `<span class="error">Error loading debug info: ${e.message}</span>`;
  }
}

// Load users on page start
async function loadUsers() {
  try {
    const response = await fetch('users.json?' + Date.now());
    const data = await response.json();
    
    let users = [];
    if (Array.isArray(data)) {
      users = data;
    } else if (data && Array.isArray(data.users)) {
      users = data.users;
    }
    
    localStorage.setItem('pc_users', JSON.stringify(users));
    console.log('Users loaded:', users.length);
    await updateDebugInfo();
    return users;
  } catch (error) {
    console.error('Error loading users:', error);
    // Try to load from localStorage
    const stored = localStorage.getItem('pc_users');
    if (stored) {
      await updateDebugInfo();
      return JSON.parse(stored);
    }
    return [];
  }
}

// Login function
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const statusEl = document.getElementById('loginStatus');
  const btn = document.getElementById('loginBtn');
  
  statusEl.innerHTML = '';
  
  if (!email || !password) {
    statusEl.innerHTML = '<span class="error">‚ùå Please fill in all fields</span>';
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Logging in...';
  
  try {
    // Get users
    const users = JSON.parse(localStorage.getItem('pc_users') || '[]');
    
    // Find user
    const user = users.find(u => u.email && u.email.toLowerCase() === email.toLowerCase());
    
    if (!user) {
      statusEl.innerHTML = '<span class="error">‚ùå Email not found</span>';
      btn.disabled = false;
      btn.textContent = 'Log In';
      return;
    }
    
    if (user.status === 'suspended') {
      statusEl.innerHTML = '<span class="error">‚ùå Account suspended</span>';
      btn.disabled = false;
      btn.textContent = 'Log In';
      return;
    }
    
    // Check password
    const hashedPassword = await hashPassword(password);
    
    if (hashedPassword !== user.passwordHash) {
      statusEl.innerHTML = '<span class="error">‚ùå Invalid password</span>';
      btn.disabled = false;
      btn.textContent = 'Log In';
      return;
    }
    
    // Success - store user session
    const sessionUser = { ...user };
    delete sessionUser.passwordHash;
    
    localStorage.setItem('pc_user', JSON.stringify(sessionUser));
    sessionStorage.setItem('pc_user', JSON.stringify(sessionUser));
    
    statusEl.innerHTML = '<span class="success">‚úÖ Login successful! Redirecting...</span>';
    
    // Redirect based on role
    setTimeout(() => {
      const redirect = user.role === 'admin' ? '/admin' : '/';
      window.location.href = redirect;
    }, 1000);
    
  } catch (error) {
    statusEl.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
    btn.disabled = false;
    btn.textContent = 'Log In';
  }
}

// Quick test function
async function testLogin() {
  document.getElementById('loginEmail').value = 'admin@theprofitscircle.co.uk';
  document.getElementById('loginPassword').value = 'admin123';
  await doLogin();
}

// Check if already logged in
(function() {
  const userStr = localStorage.getItem('pc_user') || sessionStorage.getItem('pc_user');
  if (userStr) {
    try {
      const user = JSON.parse(userStr);
      if (user.role === 'admin') {
        window.location.href = '/admin';
      } else {
        window.location.href = '/';
      }
    } catch (e) {
      // Ignore parse errors
    }
  }
})();

// Initialize
loadUsers();

// Make functions global
window.doLogin = doLogin;
window.testLogin = testLogin;
window.toggleDebug = toggleDebug;
</script>
</body>
</html>
