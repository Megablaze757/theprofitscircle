<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login â€“ The Profits Circle</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    /* Keep your existing styles */
  </style>
</head>
<body style="background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(212,168,67,0.1), transparent), var(--black);">

<div class="login-container">
  <div class="login-box">
    <!-- Keep your existing logo and form HTML -->
    
    <form id="loginForm" onsubmit="event.preventDefault(); doLogin();">
      <!-- Your form fields -->
    </form>
  </div>
</div>

<div class="toast" id="siteToast"><span id="siteToastMsg"></span></div>

<script>
// ============================================
// FIXED LOGIN PAGE
// ============================================

// Clear any existing sessions on login page load
(function clearExistingSessions() {
  // Don't redirect if already on login page
  if (window.location.pathname === '/login') {
    // Clear any existing sessions
    localStorage.removeItem('pc_user');
    sessionStorage.removeItem('pc_user');
    // Keep user cache but clear session
    console.log('Login page loaded - sessions cleared');
  }
})();

// Toast function
function showToast(message, type = 'info') {
  const toast = document.getElementById('siteToast');
  const msgEl = document.getElementById('siteToastMsg');
  if (toast && msgEl) {
    msgEl.textContent = message;
    toast.className = 'toast show ' + type;
    setTimeout(() => toast.className = 'toast', 3000);
  }
}

// Password hashing
async function hashPassword(password) {
  const msgBuffer = new TextEncoder().encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// Load users
async function loadUsers() {
  try {
    const response = await fetch('users.json?' + Date.now());
    const data = await response.json();
    
    let users = [];
    if (Array.isArray(data)) {
      users = data;
    } else if (data && Array.isArray(data.users)) {
      users = data.users;
    }
    
    localStorage.setItem('pc_users', JSON.stringify(users));
    return users;
  } catch (error) {
    console.error('Error loading users:', error);
    const cached = localStorage.getItem('pc_users');
    return cached ? JSON.parse(cached) : [];
  }
}

// Login function
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const btn = document.getElementById('loginBtn');
  const errorEl = document.getElementById('errorMessage');
  
  // Clear previous errors
  if (errorEl) errorEl.classList.remove('show');
  
  if (!email || !password) {
    showToast('Please enter both email and password', 'error');
    return;
  }
  
  // Show loading
  btn.disabled = true;
  btn.innerHTML = '<span class="loading-spinner"></span> Logging in...';
  
  try {
    const users = await loadUsers();
    const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());
    
    if (!user) {
      showToast('Invalid email or password', 'error');
      btn.disabled = false;
      btn.innerHTML = 'Log In';
      return;
    }
    
    if (user.status === 'suspended') {
      showToast('Account suspended', 'error');
      btn.disabled = false;
      btn.innerHTML = 'Log In';
      return;
    }
    
    const hashedPassword = await hashPassword(password);
    
    if (hashedPassword !== user.passwordHash) {
      showToast('Invalid email or password', 'error');
      btn.disabled = false;
      btn.innerHTML = 'Log In';
      return;
    }
    
    // Create session user (without password hash)
    const sessionUser = {
      id: user.id,
      name: user.name,
      email: user.email,
      role: user.role,
      plan: user.plan,
      vip: user.vip || false,
      status: user.status,
      affiliate: user.affiliate || false,
      referralCode: user.referralCode || ''
    };
    
    // Clear any existing sessions first
    localStorage.removeItem('pc_user');
    sessionStorage.removeItem('pc_user');
    
    // Set new session
    localStorage.setItem('pc_user', JSON.stringify(sessionUser));
    sessionStorage.setItem('pc_user', JSON.stringify(sessionUser));
    
    showToast(`Welcome back, ${user.name}!`, 'success');
    
    // Get redirect URL
    const redirect = sessionStorage.getItem('pc_redirect') || (user.role === 'admin' ? '/admin' : '/dashboard');
    sessionStorage.removeItem('pc_redirect');
    
    // Redirect
    setTimeout(() => {
      window.location.replace(redirect);
    }, 1000);
    
  } catch (error) {
    console.error('Login error:', error);
    showToast('Login failed. Please try again.', 'error');
    btn.disabled = false;
    btn.innerHTML = 'Log In';
  }
}

// Pre-load users
loadUsers();

// Make functions global
window.doLogin = doLogin;
</script>

</body>
</html>
