<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ‚Äì The Profits Circle</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    body { overflow-x: hidden; }
    .admin-topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 60px; background: rgba(10,10,10,.98); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; gap:1rem; }
    .admin-topbar-brand { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; white-space: nowrap; flex-shrink: 0; }
    .admin-topbar-brand span { color: var(--gold); }
    .admin-wrap { padding-top: 60px; display: grid; grid-template-columns: 230px 1fr; min-height: 100vh; }
    .admin-sidebar { background: var(--black2); border-right: 1px solid var(--border); padding: 1.25rem .875rem; position: sticky; top: 60px; height: calc(100vh - 60px); overflow-y: auto; display: flex; flex-direction: column; gap: .2rem; }
    .admin-sidebar-group { font-size: .65rem; font-weight: 800; text-transform: uppercase; letter-spacing: .1em; color: var(--white3); padding: .75rem 1rem .3rem; margin-top: .5rem; }
    .admin-content { padding: 1.75rem; overflow-y: auto; min-width: 0; }
    @media(max-width:900px) { .admin-wrap { grid-template-columns: 1fr; } .admin-sidebar { display: none; } }
    .admin-section { display: none; }
    .admin-section.active { display: block; animation: fadeIn .3s ease; }
    .stat-card { background: var(--black3); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem 1.5rem; }
    .stat-num { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; letter-spacing: 1px; line-height: 1; margin-bottom: .2rem; }
    .stat-label { font-size: .72rem; color: var(--white3); text-transform: uppercase; letter-spacing: .08em; font-weight: 700; }
    .search-row { display: flex; gap: .75rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
    .search-row input { flex: 1; min-width: 200px; }
    .mobile-nav-pills { display: none; gap: .4rem; flex-wrap: wrap; margin-bottom: 1.25rem; }
    @media(max-width:900px) { .mobile-nav-pills { display: flex; } }
    .form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: .75rem; }
    @media(max-width:640px) { .form-row-2, .form-row-3 { grid-template-columns: 1fr; } }
    .aff-code-box { background: var(--black4); border: 1px solid var(--gold-border); border-radius: 10px; padding: .5rem 1rem; font-family: 'JetBrains Mono', monospace; font-size:.9rem; font-weight: 700; color: var(--gold2); letter-spacing: 2px; display: inline-flex; align-items: center; gap: .5rem; cursor: pointer; transition: all .2s; }
    .aff-code-box:hover { background: var(--gold-dim); }
    .ref-link-box { background: var(--black4); border: 1px solid var(--border2); border-radius: 10px; padding: .5rem 1rem; font-size: .78rem; color: var(--white2); font-family: 'JetBrains Mono', monospace; word-break: break-all; cursor: pointer; }
    .plan-badge-free { background: var(--green-dim); border: 1px solid var(--green-border); color: var(--green); }
    .plan-badge-paid { background: var(--red-dim); border: 1px solid var(--red-border); color: var(--red); }
    .plan-badge-vip { background: var(--gold-dim); border: 1px solid var(--gold-border); color: var(--gold); }
  </style>
</head>
<body>

<!-- TOP BAR -->
<div class="admin-topbar">
  <div class="admin-topbar-brand">THE <span>PROFITS</span> CIRCLE <span style="color:var(--white3);font-size:.75rem;"> ¬∑ ADMIN</span></div>
  <div style="display:flex;align-items:center;gap:.75rem;flex-shrink:0;">
    <span id="adminUserLabel" style="font-size:.82rem;color:var(--white3);"></span>
    <a href="./" class="btn btn-ghost btn-sm">View Site</a>
    <button class="btn btn-danger btn-sm" onclick="PC.logout()">Log Out</button>
  </div>
</div>

<div class="admin-wrap">
  <!-- SIDEBAR -->
  <div class="admin-sidebar">
    <div class="admin-sidebar-group">Overview</div>
    <button class="admin-nav-link active" data-section="dashboard" onclick="showSection('dashboard',this)">üìä Dashboard</button>

    <div class="admin-sidebar-group">Users</div>
    <button class="admin-nav-link" data-section="users" onclick="showSection('users',this)">üë• All Users</button>
    <button class="admin-nav-link" data-section="adduser" onclick="showSection('adduser',this)">‚ûï Add User</button>

    <div class="admin-sidebar-group">Affiliates</div>
    <button class="admin-nav-link" data-section="affiliates" onclick="showSection('affiliates',this)">ü§ù Affiliates</button>
    <button class="admin-nav-link" data-section="addaffiliate" onclick="showSection('addaffiliate',this)">‚ûï Add Affiliate</button>

    <div class="admin-sidebar-group">Signals</div>
    <button class="admin-nav-link" data-section="signals" onclick="showSection('signals',this)">üì° Signal History</button>
    <button class="admin-nav-link" data-section="addsignal" onclick="showSection('addsignal',this)">üì§ Add Signal</button>

    <div style="flex:1;"></div>
    <div style="border-top:1px solid var(--border);padding-top:.75rem;margin-top:.75rem;">
      <a href="./" class="admin-nav-link" style="text-decoration:none;">üåê View Site</a>
      <button class="admin-nav-link" style="color:var(--red);" onclick="PC.logout()">üö™ Log Out</button>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="admin-content">

    <!-- Mobile nav pills -->
    <div class="mobile-nav-pills">
      <button class="btn btn-ghost btn-sm" onclick="showSection('dashboard')">üìä</button>
      <button class="btn btn-ghost btn-sm" onclick="showSection('users')">üë• Users</button>
      <button class="btn btn-ghost btn-sm" onclick="showSection('adduser')">‚ûï User</button>
      <button class="btn btn-ghost btn-sm" onclick="showSection('affiliates')">ü§ù Affiliates</button>
      <button class="btn btn-ghost btn-sm" onclick="showSection('addaffiliate')">‚ûï Affiliate</button>
      <button class="btn btn-ghost btn-sm" onclick="showSection('signals')">üì° Signals</button>
      <button class="btn btn-ghost btn-sm" onclick="showSection('addsignal')">üì§ Signal</button>
    </div>

    <!-- ========== DASHBOARD ========== -->
    <div class="admin-section active" id="section-dashboard">
      <h2 class="mb-3">Dashboard <span class="text-gold">Overview</span></h2>
      <div class="grid-4 mb-3" id="dashStats"></div>
      <div class="grid-2">
        <div class="card">
          <h3 class="mb-2" style="font-size:.95rem;">Recent Signups</h3>
          <div id="recentUsers" style="display:flex;flex-direction:column;gap:.4rem;"></div>
        </div>
        <div class="card">
          <h3 class="mb-2" style="font-size:.95rem;">Top Affiliates</h3>
          <div id="topAffiliates" style="display:flex;flex-direction:column;gap:.4rem;"></div>
        </div>
      </div>
    </div>

    <!-- ========== USERS ========== -->
    <div class="admin-section" id="section-users">
      <div class="flex items-center justify-between mb-3" style="flex-wrap:wrap;gap:1rem;">
        <h2>User <span class="text-gold">Management</span></h2>
        <button class="btn btn-gold" onclick="showSection('adduser')">‚ûï Add User</button>
      </div>
      <div class="search-row">
        <input type="text" class="form-input" id="userSearch" placeholder="Search name or email..." oninput="renderUserTable()" />
        <select class="form-select" id="userFilter" onchange="renderUserTable()" style="width:auto;min-width:140px;">
          <option value="all">All Users</option>
          <option value="vip">VIP</option>
          <option value="paid">Paid</option>
          <option value="free">Free</option>
          <option value="affiliate">Affiliates</option>
          <option value="suspended">Suspended</option>
        </select>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>Name</th><th>Email</th><th>Plan</th><th>Affiliate</th><th>Status</th><th>Referred By</th><th>Joined</th><th>Actions</th></tr></thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ========== ADD USER ========== -->
    <div class="admin-section" id="section-adduser">
      <h2 class="mb-3">‚ûï Add <span class="text-gold">User</span></h2>
      <div class="card" style="max-width:580px;">
        <div class="form-row-2">
          <div class="form-group"><label class="form-label">Full Name *</label><input type="text" class="form-input" id="au_name" placeholder="John Smith" /></div>
          <div class="form-group"><label class="form-label">Email *</label><input type="email" class="form-input" id="au_email" placeholder="john@email.com" /></div>
        </div>
        <div class="form-row-2">
          <div class="form-group"><label class="form-label">Password *</label><input type="text" class="form-input" id="au_password" placeholder="Temporary password" /></div>
          <div class="form-group"><label class="form-label">Role</label>
            <select class="form-select" id="au_role"><option value="user">User</option><option value="admin">Admin</option></select>
          </div>
        </div>
        <div class="form-row-2">
          <div class="form-group"><label class="form-label">Plan</label>
            <select class="form-select" id="au_plan">
              <option value="free">Free</option>
              <option value="paid">Paid ($45/mo)</option>
              <option value="vip">VIP Gold</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">Status</label>
            <select class="form-select" id="au_status"><option value="active">Active</option><option value="suspended">Suspended</option></select>
          </div>
        </div>
        <div class="form-row-2">
          <div class="form-group"><label class="form-label">Make Affiliate?</label>
            <select class="form-select" id="au_affiliate"><option value="false">No</option><option value="true">Yes</option></select>
          </div>
          <div class="form-group"><label class="form-label">Referral Code <span style="color:var(--white3);font-weight:400;">(if affiliate)</span></label>
            <input type="text" class="form-input" id="au_refcode" placeholder="e.g. JOHN99" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()" />
          </div>
        </div>
        <div class="form-group"><label class="form-label">Referred By (referral code)</label>
          <input type="text" class="form-input" id="au_referredby" placeholder="Leave blank if none" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()" />
        </div>
        <div style="display:flex;gap:.75rem;flex-wrap:wrap;">
          <button class="btn btn-gold" onclick="addUser()">Create User</button>
          <button class="btn btn-ghost" onclick="showSection('users')">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ========== AFFILIATES ========== -->
    <div class="admin-section" id="section-affiliates">
      <div class="flex items-center justify-between mb-3" style="flex-wrap:wrap;gap:1rem;">
        <h2>Affiliate <span class="text-gold">Management</span></h2>
        <button class="btn btn-gold" onclick="showSection('addaffiliate')">‚ûï Add Affiliate</button>
      </div>

      <!-- Affiliate Stats -->
      <div class="grid-4 mb-3" id="affStats"></div>

      <div class="table-wrap mb-3">
        <table class="table">
          <thead><tr><th>Affiliate</th><th>Referral Code</th><th>Referral Link</th><th>Referrals</th><th>Earnings</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="affiliateTableBody"></tbody>
        </table>
      </div>

      <!-- Referral breakdown -->
      <h3 class="mb-2">All Referrals</h3>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>User</th><th>Email</th><th>Plan</th><th>Referred By</th><th>Joined</th></tr></thead>
          <tbody id="referralTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ========== ADD AFFILIATE ========== -->
    <div class="admin-section" id="section-addaffiliate">
      <h2 class="mb-3">‚ûï Add <span class="text-gold">Affiliate</span></h2>
      <div class="card" style="max-width:500px;">
        <p class="text-dim mb-3" style="font-size:.9rem;">Promote an existing user to affiliate status and assign them a referral code. Or create a new user as an affiliate.</p>
        <div class="form-group">
          <label class="form-label">Select Existing User</label>
          <select class="form-select" id="aff_user_select" onchange="prefillAffCode()">
            <option value="">‚Äî Choose user ‚Äî</option>
          </select>
        </div>
        <div class="form-row-2">
          <div class="form-group">
            <label class="form-label">Referral Code *</label>
            <input type="text" class="form-input" id="aff_code" placeholder="e.g. SARAH10" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()" />
          </div>
          <div class="form-group">
            <label class="form-label">Initial Earnings ($)</label>
            <input type="number" class="form-input" id="aff_earnings" placeholder="0" value="0" />
          </div>
        </div>
        <div style="background:var(--black4);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:1rem;" id="affLinkPreview" style="display:none;">
          <div style="font-size:.75rem;color:var(--white3);margin-bottom:.35rem;text-transform:uppercase;letter-spacing:.06em;font-weight:700;">Referral Link Preview</div>
          <div class="ref-link-box" id="affLinkPreviewUrl" onclick="copyText(this.textContent)"></div>
          <div style="font-size:.72rem;color:var(--white3);margin-top:.35rem;">Click to copy</div>
        </div>
        <div style="display:flex;gap:.75rem;flex-wrap:wrap;">
          <button class="btn btn-gold" onclick="makeAffiliate()">Make Affiliate</button>
          <button class="btn btn-ghost" onclick="showSection('affiliates')">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ========== SIGNALS ========== -->
    <div class="admin-section" id="section-signals">
      <div class="flex items-center justify-between mb-3" style="flex-wrap:wrap;gap:1rem;">
        <h2>Signal <span class="text-gold">History</span></h2>
        <button class="btn btn-gold" onclick="showSection('addsignal')">üì§ Add Signal</button>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>Date</th><th>Dir</th><th>Entry</th><th>TP</th><th>SL</th><th>Result</th><th>P&amp;L</th><th>Actions</th></tr></thead>
          <tbody id="signalTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ========== ADD SIGNAL ========== -->
    <div class="admin-section" id="section-addsignal">
      <h2 class="mb-3">üì§ Add <span class="text-gold">Signal</span></h2>
      <div class="card" style="max-width:560px;">
        <div class="form-row-2">
          <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="as_date" /></div>
          <div class="form-group"><label class="form-label">Direction</label>
            <select class="form-select" id="as_dir"><option value="BUY">BUY</option><option value="SELL">SELL</option></select>
          </div>
        </div>
        <div class="form-row-3">
          <div class="form-group"><label class="form-label">Entry</label><input type="number" class="form-input" id="as_entry" placeholder="3248.50" step="0.01" /></div>
          <div class="form-group"><label class="form-label">Take Profit</label><input type="number" class="form-input" id="as_tp" placeholder="3285.00" step="0.01" /></div>
          <div class="form-group"><label class="form-label">Stop Loss</label><input type="number" class="form-input" id="as_sl" placeholder="3228.00" step="0.01" /></div>
        </div>
        <div class="form-row-3">
          <div class="form-group"><label class="form-label">Status</label>
            <select class="form-select" id="as_status"><option value="active">Active</option><option value="closed">Closed</option></select>
          </div>
          <div class="form-group"><label class="form-label">Result</label>
            <select class="form-select" id="as_result"><option value="">Pending</option><option value="win">Win</option><option value="loss">Loss</option></select>
          </div>
          <div class="form-group"><label class="form-label">P&amp;L ($)</label><input type="number" class="form-input" id="as_pnl" placeholder="1650" /></div>
        </div>
        <div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="as_notes" placeholder="Optional notes..." /></div>
        <div style="display:flex;gap:.75rem;flex-wrap:wrap;">
          <button class="btn btn-gold" onclick="addSignal()">Publish Signal</button>
          <button class="btn btn-ghost" onclick="showSection('signals')">Cancel</button>
        </div>
      </div>
    </div>

  </div><!-- /admin-content -->
</div><!-- /admin-wrap -->

<!-- EDIT USER MODAL -->
<div class="modal-overlay" id="editUserModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Edit User</h3>
      <button class="modal-close" onclick="PC.closeModal('editUserModal')">‚úï</button>
    </div>
    <input type="hidden" id="eu_id" />
    <div class="form-row-2" style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;">
      <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="eu_name" /></div>
      <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="eu_email" /></div>
    </div>
    <div class="form-row-2" style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;">
      <div class="form-group"><label class="form-label">Plan</label>
        <select class="form-select" id="eu_plan">
          <option value="free">Free</option>
          <option value="paid">Paid ($45/mo)</option>
          <option value="vip">VIP Gold</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Status</label>
        <select class="form-select" id="eu_status"><option value="active">Active</option><option value="suspended">Suspended</option></select>
      </div>
    </div>
    <div class="form-row-2" style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;">
      <div class="form-group"><label class="form-label">Affiliate?</label>
        <select class="form-select" id="eu_affiliate"><option value="false">No</option><option value="true">Yes</option></select>
      </div>
      <div class="form-group"><label class="form-label">Referral Code</label>
        <input type="text" class="form-input" id="eu_refcode" placeholder="Leave blank if not affiliate" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()" />
      </div>
    </div>
    <div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-top:.5rem;">
      <button class="btn btn-gold" onclick="saveEditUser()">Save Changes</button>
      <button class="btn btn-ghost" onclick="PC.closeModal('editUserModal')">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="siteToast"><span id="siteToastMsg"></span></div>

<script src="assets/app.js"></script>
<script>
// Auth guard
(function() {
  const u = PC.getUser();
  if (!u || u.role !== 'admin') {
    sessionStorage.setItem('pc_redirect', './admin.html');
    window.location.href = './login.html';
  }
})();

const adminUser = PC.getUser();
if (adminUser) document.getElementById('adminUserLabel').textContent = adminUser.name;
document.getElementById('as_date').valueAsDate = new Date();

const SITE_BASE = window.location.origin + window.location.pathname.replace(/admin\.html.*$/, '');

// ---- HELPERS ----
function planBadge(plan) {
  if (!plan || plan === 'free') return `<span class="badge plan-badge-free" style="font-size:.65rem;">Free</span>`;
  if (plan === 'paid') return `<span class="badge plan-badge-paid" style="font-size:.65rem;">Paid $45</span>`;
  if (plan === 'vip') return `<span class="badge plan-badge-vip" style="font-size:.65rem;">üëë VIP</span>`;
  return plan;
}

function copyText(text) {
  navigator.clipboard.writeText(text).then(() => PC.toast('Copied! ‚úì', 'success'));
}

// ---- SECTION NAV ----
function showSection(id, btn) {
  document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.admin-nav-link').forEach(b => b.classList.remove('active'));
  const sec = document.getElementById('section-' + id);
  if (sec) sec.classList.add('active');
  if (btn) btn.classList.add('active');
  else document.querySelectorAll(`.admin-nav-link[data-section="${id}"]`).forEach(b => b.classList.add('active'));
  // Refresh
  if (id === 'dashboard') renderDashboard();
  if (id === 'users') renderUserTable();
  if (id === 'affiliates') renderAffiliates();
  if (id === 'signals') renderSignalTable();
  if (id === 'addaffiliate') populateAffUserSelect();
}

// ---- DASHBOARD ----
function renderDashboard() {
  const users = PC.getUsers();
  const signals = PC.getSignals();
  const affiliates = users.filter(u => u.affiliate);
  const vipCount = users.filter(u => u.plan === 'vip').length;
  const paidCount = users.filter(u => u.plan === 'paid').length;
  const activeSignals = signals.filter(s => s.status === 'active').length;
  const closedWins = signals.filter(s => s.result === 'win').length;
  const totalClosed = signals.filter(s => s.status === 'closed').length;
  const wr = totalClosed ? Math.round(closedWins/totalClosed*100) : 0;
  const totalAffEarnings = affiliates.reduce((a,u) => a + (u.earnings||0), 0);

  document.getElementById('dashStats').innerHTML = `
    <div class="stat-card"><div class="stat-num">${users.length}</div><div class="stat-label">Total Users</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--gold2);">${vipCount}</div><div class="stat-label">VIP Members</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--red);">${paidCount}</div><div class="stat-label">Paid Members</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--green);">${wr}%</div><div class="stat-label">Win Rate</div></div>
  `;

  document.getElementById('recentUsers').innerHTML = users.slice(-5).reverse().map(u => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:.55rem .75rem;background:var(--black4);border-radius:10px;gap:.5rem;flex-wrap:wrap;">
      <div>
        <div style="font-size:.85rem;font-weight:600;">${u.name}</div>
        <div style="font-size:.72rem;color:var(--white3);">${u.email}</div>
      </div>
      <div style="display:flex;gap:.3rem;align-items:center;flex-shrink:0;">${planBadge(u.plan)}</div>
    </div>`).join('');

  document.getElementById('topAffiliates').innerHTML = affiliates.length ? affiliates.sort((a,b) => (b.earnings||0)-(a.earnings||0)).slice(0,5).map(u => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:.55rem .75rem;background:var(--black4);border-radius:10px;gap:.5rem;flex-wrap:wrap;">
      <div>
        <div style="font-size:.85rem;font-weight:600;">${u.name}</div>
        <div class="aff-code-box" style="padding:.15rem .6rem;font-size:.72rem;cursor:default;" title="Referral code">${u.referralCode || '‚Äî'}</div>
      </div>
      <div style="font-weight:700;color:var(--green);font-size:.9rem;">$${(u.earnings||0).toLocaleString()}</div>
    </div>`).join('') : `<p class="text-muted" style="font-size:.85rem;">No affiliates yet.</p>`;
}

// ---- USERS ----
function renderUserTable() {
  const q = (document.getElementById('userSearch')?.value || '').toLowerCase();
  const f = document.getElementById('userFilter')?.value || 'all';
  let users = PC.getUsers();
  if (q) users = users.filter(u => u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q));
  if (f === 'vip') users = users.filter(u => u.plan === 'vip');
  if (f === 'paid') users = users.filter(u => u.plan === 'paid');
  if (f === 'free') users = users.filter(u => !u.plan || u.plan === 'free');
  if (f === 'affiliate') users = users.filter(u => u.affiliate);
  if (f === 'suspended') users = users.filter(u => u.status === 'suspended');

  document.getElementById('userTableBody').innerHTML = users.map(u => `
    <tr>
      <td style="font-weight:600;color:var(--white);">${u.name}</td>
      <td style="color:var(--white2);font-size:.82rem;">${u.email}</td>
      <td>${planBadge(u.plan)}</td>
      <td>${u.affiliate ? `<span class="aff-code-box" style="padding:.2rem .6rem;font-size:.72rem;" onclick="copyText('${SITE_BASE}login.html?ref=${u.referralCode}')">${u.referralCode}</span>` : '<span style="color:var(--white3);font-size:.82rem;">‚Äî</span>'}</td>
      <td><span style="font-size:.8rem;font-weight:700;color:${u.status==='active'?'var(--green)':'var(--red)'};">${u.status}</span></td>
      <td style="font-size:.82rem;color:var(--white3);">${u.referredBy || '‚Äî'}</td>
      <td style="font-size:.78rem;color:var(--white3);">${u.joined||'‚Äî'}</td>
      <td>
        <div style="display:flex;gap:.35rem;flex-wrap:nowrap;">
          <button class="btn btn-sm btn-ghost" onclick="openEditUser(${u.id})" style="min-height:30px;font-size:.72rem;">Edit</button>
          ${u.role !== 'admin' ? `
          <button class="btn btn-sm" onclick="toggleSuspend(${u.id})" style="min-height:30px;font-size:.72rem;${u.status==='suspended'?'background:var(--green-dim);color:var(--green);border:1px solid var(--green-border);':'background:var(--red-dim);color:var(--red);border:1px solid var(--red-border);'}">${u.status==='suspended'?'Restore':'Suspend'}</button>
          <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})" style="min-height:30px;font-size:.72rem;">‚úï</button>` : ''}
        </div>
      </td>
    </tr>`).join('') || `<tr><td colspan="8" style="text-align:center;color:var(--white3);padding:2rem;">No users found</td></tr>`;
}

function openEditUser(id) {
  const u = PC.getUsers().find(x => x.id === id);
  if (!u) return;
  document.getElementById('eu_id').value = u.id;
  document.getElementById('eu_name').value = u.name;
  document.getElementById('eu_email').value = u.email;
  document.getElementById('eu_plan').value = u.plan || 'free';
  document.getElementById('eu_status').value = u.status;
  document.getElementById('eu_affiliate').value = String(u.affiliate || false);
  document.getElementById('eu_refcode').value = u.referralCode || '';
  PC.openModal('editUserModal');
}

function saveEditUser() {
  const id = parseInt(document.getElementById('eu_id').value);
  const users = PC.getUsers();
  const idx = users.findIndex(u => u.id === id);
  if (idx < 0) return;
  const plan = document.getElementById('eu_plan').value;
  users[idx].name = document.getElementById('eu_name').value.trim();
  users[idx].email = document.getElementById('eu_email').value.trim();
  users[idx].plan = plan;
  users[idx].vip = (plan === 'vip');
  users[idx].status = document.getElementById('eu_status').value;
  users[idx].affiliate = document.getElementById('eu_affiliate').value === 'true';
  users[idx].referralCode = document.getElementById('eu_refcode').value.toUpperCase().trim();
  PC.saveUsers(users);
  PC.closeModal('editUserModal');
  PC.toast('User updated ‚úì', 'success');
  renderUserTable();
}

function toggleSuspend(id) {
  const users = PC.getUsers();
  const u = users.find(x => x.id === id);
  if (!u || u.role === 'admin') return;
  u.status = u.status === 'suspended' ? 'active' : 'suspended';
  PC.saveUsers(users);
  PC.toast(`${u.name} ${u.status === 'suspended' ? 'suspended' : 'reactivated'}`, u.status === 'suspended' ? 'error' : 'success');
  renderUserTable();
}

function deleteUser(id) {
  const u = PC.getUsers().find(x => x.id === id);
  if (!u || u.role === 'admin') return;
  if (!confirm(`Delete "${u.name}"? This cannot be undone.`)) return;
  PC.saveUsers(PC.getUsers().filter(x => x.id !== id));
  PC.toast(`${u.name} deleted`);
  renderUserTable();
}

function addUser() {
  const name = document.getElementById('au_name').value.trim();
  const email = document.getElementById('au_email').value.trim();
  const password = document.getElementById('au_password').value;
  const role = document.getElementById('au_role').value;
  const plan = document.getElementById('au_plan').value;
  const status = document.getElementById('au_status').value;
  const affiliate = document.getElementById('au_affiliate').value === 'true';
  const referralCode = document.getElementById('au_refcode').value.toUpperCase().trim();
  const referredBy = document.getElementById('au_referredby').value.toUpperCase().trim();
  if (!name || !email || !password) { PC.toast('Please fill in required fields', 'error'); return; }
  if (PC.findUser(email)) { PC.toast('Email already exists', 'error'); return; }
  if (referralCode && PC.findUserByReferral(referralCode)) { PC.toast('Referral code already taken', 'error'); return; }
  const users = PC.getUsers();
  users.push({ id: Date.now(), name, email, password, role, plan, vip: plan === 'vip', status, joined: new Date().toISOString().slice(0,10), affiliate, referralCode: affiliate ? referralCode : '', referredBy, earnings: 0 });
  PC.saveUsers(users);
  PC.toast(`"${name}" created ‚úì`, 'success');
  ['au_name','au_email','au_password','au_refcode','au_referredby'].forEach(id => document.getElementById(id).value = '');
  showSection('users');
}

// ---- AFFILIATES ----
function renderAffiliates() {
  const users = PC.getUsers();
  const affiliates = users.filter(u => u.affiliate);
  const referred = users.filter(u => u.referredBy);
  const totalEarnings = affiliates.reduce((a,u) => a + (u.earnings||0), 0);

  document.getElementById('affStats').innerHTML = `
    <div class="stat-card"><div class="stat-num" style="color:var(--gold2);">${affiliates.length}</div><div class="stat-label">Active Affiliates</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--green);">${referred.length}</div><div class="stat-label">Total Referrals</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--green);">$${totalEarnings.toLocaleString()}</div><div class="stat-label">Total Paid Out</div></div>
    <div class="stat-card"><div class="stat-num">${affiliates.length ? Math.round(referred.length/affiliates.length*10)/10 : 0}</div><div class="stat-label">Avg. Referrals</div></div>
  `;

  const refCountMap = {};
  referred.forEach(u => { if(u.referredBy) refCountMap[u.referredBy] = (refCountMap[u.referredBy]||0)+1; });

  document.getElementById('affiliateTableBody').innerHTML = affiliates.map(u => {
    const link = SITE_BASE + 'login.html?ref=' + u.referralCode;
    const refCount = refCountMap[u.referralCode] || 0;
    return `<tr>
      <td style="font-weight:600;color:var(--white);">${u.name}<br><span style="font-size:.75rem;color:var(--white3);">${u.email}</span></td>
      <td><div class="aff-code-box" onclick="copyText('${u.referralCode}')" title="Click to copy code">${u.referralCode || '‚Äî'}</div></td>
      <td><div class="ref-link-box" onclick="copyText('${link}')" title="Click to copy link">${link}</div></td>
      <td style="font-weight:700;">${refCount}</td>
      <td style="font-weight:700;color:var(--green);">$${(u.earnings||0).toLocaleString()}</td>
      <td><span style="font-size:.8rem;font-weight:700;color:${u.status==='active'?'var(--green)':'var(--red)'};">${u.status}</span></td>
      <td>
        <div style="display:flex;gap:.35rem;flex-wrap:nowrap;">
          <button class="btn btn-sm btn-ghost" onclick="openEditUser(${u.id})" style="min-height:30px;font-size:.72rem;">Edit</button>
          <button class="btn btn-sm" onclick="updateEarnings(${u.id})" style="min-height:30px;font-size:.72rem;background:var(--green-dim);color:var(--green);border:1px solid var(--green-border);">+ Earnings</button>
          <button class="btn btn-sm btn-danger" onclick="removeAffiliate(${u.id})" style="min-height:30px;font-size:.72rem;">Remove</button>
        </div>
      </td>
    </tr>`;
  }).join('') || `<tr><td colspan="7" style="text-align:center;color:var(--white3);padding:2rem;">No affiliates yet. <button class="btn btn-sm btn-gold" onclick="showSection('addaffiliate')" style="margin-left:.5rem;">Add one ‚Üí</button></td></tr>`;

  // Referral breakdown
  document.getElementById('referralTableBody').innerHTML = referred.map(u => `
    <tr>
      <td style="font-weight:600;color:var(--white);">${u.name}</td>
      <td style="font-size:.82rem;color:var(--white2);">${u.email}</td>
      <td>${planBadge(u.plan)}</td>
      <td><span class="aff-code-box" style="padding:.2rem .6rem;font-size:.72rem;cursor:default;">${u.referredBy}</span></td>
      <td style="font-size:.78rem;color:var(--white3);">${u.joined||'‚Äî'}</td>
    </tr>`).join('') || `<tr><td colspan="5" style="text-align:center;color:var(--white3);padding:1.5rem;">No referrals yet</td></tr>`;
}

function updateEarnings(id) {
  const amt = prompt('Add earnings amount ($):');
  if (!amt || isNaN(parseFloat(amt))) return;
  const users = PC.getUsers();
  const u = users.find(x => x.id === id);
  if (!u) return;
  u.earnings = (u.earnings || 0) + parseFloat(amt);
  PC.saveUsers(users);
  PC.toast(`+$${parseFloat(amt)} added to ${u.name}`, 'success');
  renderAffiliates();
}

function removeAffiliate(id) {
  if (!confirm('Remove affiliate status from this user?')) return;
  const users = PC.getUsers();
  const u = users.find(x => x.id === id);
  if (!u) return;
  u.affiliate = false;
  u.referralCode = '';
  PC.saveUsers(users);
  PC.toast(`${u.name} removed as affiliate`);
  renderAffiliates();
}

function populateAffUserSelect() {
  const users = PC.getUsers().filter(u => !u.affiliate && u.role !== 'admin');
  const sel = document.getElementById('aff_user_select');
  sel.innerHTML = `<option value="">‚Äî Choose user ‚Äî</option>` + users.map(u => `<option value="${u.id}">${u.name} (${u.email})</option>`).join('');
  document.getElementById('affLinkPreviewUrl').textContent = '';
}

function prefillAffCode() {
  const id = parseInt(document.getElementById('aff_user_select').value);
  if (!id) return;
  const u = PC.getUsers().find(x => x.id === id);
  if (!u) return;
  // Auto-generate code from name
  const code = u.name.split(' ')[0].toUpperCase().replace(/[^A-Z]/g,'') + Math.floor(Math.random()*90+10);
  document.getElementById('aff_code').value = code;
  updateAffPreview();
}

document.addEventListener('input', function(e) { if (e.target.id === 'aff_code') updateAffPreview(); });
function updateAffPreview() {
  const code = document.getElementById('aff_code').value.toUpperCase();
  const preview = document.getElementById('affLinkPreviewUrl');
  if (code) preview.textContent = SITE_BASE + 'login.html?ref=' + code;
}

function makeAffiliate() {
  const userId = parseInt(document.getElementById('aff_user_select').value);
  const code = document.getElementById('aff_code').value.toUpperCase().trim();
  const earnings = parseFloat(document.getElementById('aff_earnings').value) || 0;
  if (!userId) { PC.toast('Please select a user', 'error'); return; }
  if (!code) { PC.toast('Please enter a referral code', 'error'); return; }
  if (PC.findUserByReferral(code)) { PC.toast('Referral code already in use', 'error'); return; }
  const users = PC.getUsers();
  const u = users.find(x => x.id === userId);
  if (!u) return;
  u.affiliate = true;
  u.referralCode = code;
  u.earnings = earnings;
  PC.saveUsers(users);
  PC.toast(`${u.name} is now an affiliate with code ${code} ‚úì`, 'success');
  showSection('affiliates');
}

// ---- SIGNALS ----
function renderSignalTable() {
  const signals = PC.getSignals();
  document.getElementById('signalTableBody').innerHTML = signals.map(s => `
    <tr>
      <td style="font-size:.8rem;color:var(--white3);">${s.date}</td>
      <td>${s.dir==='BUY'?'<span class="badge badge-buy" style="font-size:.68rem;">BUY</span>':'<span class="badge badge-sell" style="font-size:.68rem;">SELL</span>'}</td>
      <td style="font-family:JetBrains Mono,monospace;font-size:.83rem;">$${s.entry}</td>
      <td style="font-family:JetBrains Mono,monospace;font-size:.83rem;">$${s.tp}</td>
      <td style="font-family:JetBrains Mono,monospace;font-size:.83rem;">$${s.sl}</td>
      <td>${s.status==='active'?'<span class="badge badge-pending" style="font-size:.65rem;">Active</span>':s.result==='win'?'<span class="badge badge-win" style="font-size:.65rem;">Win</span>':s.result==='loss'?'<span class="badge badge-loss" style="font-size:.65rem;">Loss</span>':'<span style="font-size:.75rem;color:var(--white3);">‚Äî</span>'}</td>
      <td style="font-weight:700;color:${s.pnl>0?'var(--green)':s.pnl<0?'var(--red)':'var(--white3)'};">${s.pnl?(s.pnl>0?'+':'')+'$'+Math.abs(s.pnl).toLocaleString():'‚Äî'}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteSignal(${s.id})" style="min-height:28px;font-size:.72rem;">‚úï</button></td>
    </tr>`).join('') || `<tr><td colspan="8" style="text-align:center;color:var(--white3);padding:2rem;">No signals yet</td></tr>`;
}

function addSignal() {
  const date = document.getElementById('as_date').value;
  const entry = parseFloat(document.getElementById('as_entry').value);
  const tp = parseFloat(document.getElementById('as_tp').value);
  const sl = parseFloat(document.getElementById('as_sl').value);
  if (!date || isNaN(entry) || isNaN(tp) || isNaN(sl)) { PC.toast('Please fill in required fields', 'error'); return; }
  const signals = PC.getSignals();
  signals.unshift({ id: Date.now(), date, dir: document.getElementById('as_dir').value, entry, tp, sl, status: document.getElementById('as_status').value, result: document.getElementById('as_result').value, pnl: parseFloat(document.getElementById('as_pnl').value)||null, notes: document.getElementById('as_notes').value.trim() });
  PC.saveSignals(signals);
  PC.toast('Signal published ‚úì', 'success');
  ['as_entry','as_tp','as_sl','as_pnl','as_notes'].forEach(id => document.getElementById(id).value = '');
  showSection('signals');
}

function deleteSignal(id) {
  if (!confirm('Delete this signal?')) return;
  PC.saveSignals(PC.getSignals().filter(s => s.id !== id));
  PC.toast('Signal deleted');
  renderSignalTable();
}

renderDashboard();
</script>
</body>
</html>
